<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.fm.fileSystemChange.dao.FileDao">

    <sql id="Base_Columns_List">
        cfid,cfname,cfclassifyid,cfclassifyname,cfaddress,cfdate,cfeditor,cfaccept,
        cfsend,cflevel,cffontid,cfnumber,cflanguage ,cfloader,type,isborrow,waitborrow,
        destroy,back,backDate,destroyDate,leveltime,state
    </sql>
    <sql id="Base_Borrow_List">
       fileid,uid,wid,borrowtime,backtime,borrowstate,givetime,shouldback,secondUid
    </sql>
<!--添加发文的信息-->
    <insert id="insertCompanyFile" parameterType="cn.fm.pojo.CompanyFile" >
        <selectKey  keyProperty="cfid" resultType="java.lang.Integer" order="AFTER">
            select LAST_INSERT_ID()
        </selectKey>
        insert into companyFile(cfname,cfclassifyid,cfclassifyname,cfaddress,cfdate,cfeditor,cfaccept,
        cfsend,cflevel,cffontid,cfnumber,cflanguage,cfloader , leveltime,waitborrow) values(#{cfname},
        #{cfclassifyid} ,#{cfclassifyname},#{cfaddress},#{cfdate},#{cfeditor},#{cfaccept},
        #{cfsend},#{cflevel},#{cffontid},#{cfnumber},#{cflanguage},#{cfloader}, #{leveltime} , #{waitborrow})
    </insert>
    <!--添加文件借阅信息-->
    <insert id="insertBorrow_CompanyFile" parameterType="cn.fm.pojo.Borrow">
        insert into borrow_companyFile(fileid,uid,wid,givetime) VALUES (#{fileid},#{uid},#{wid},#{givetime})
    </insert>
    <!--根据文件id查看文件信息-->
    <select id="selectCompanyFileByCFId" resultType="cn.fm.pojo.CompanyFile" parameterType="java.lang.Integer">
        select <include refid="Base_Columns_List"/> from companyFile where cfid =#{cfid};
    </select>
    <!--查借阅信息,如果borrowtime不等与null 查的是被领走的 结合backtime 查被领走,或者已归还的-->
    <select id="selectBorrow_CompanyFile" resultType="cn.fm.pojo.Borrow" parameterType="cn.fm.pojo.Borrow">
        select <include refid="Base_Borrow_List"/> from borrow_companyFile
        <where>
            <if test="fileid != 0" >
                fileid = #{fileid}
            </if>
            <if test="wid != 0">
                and wid =#{wid}
            </if>
            <if test="uid != 0">
                and uid = #{uid}
            </if>
            <if test="backtime == null">
               and backtime is null
            </if>
            <if test="backtime != null">
                and backtime is not null
            </if>
            <if test="borrowtime == null">
                and borrowtime is null
            </if>
            <if test="borrowtime != null">
                and borrowtime is not null
            </if>
            <if test="secondUid != 0">
                and secondUid=#{secondUid}
            </if>
            and borrowstate = #{borrowstate}
        </where>
    </select>
    <!--根据文件的id修改借阅表的-->
    <update id="updateBorrow_CompanyFileByCFId" parameterType="cn.fm.pojo.Borrow" >
        update borrow_companyFile
        <set>
            <if test="uid != 0">
                uid=#{uid},
            </if>
            <if test="wid != 0" >
                wid =#{wid},
            </if>
            <if test="givetime != null">
                givetime = #{givetime},
            </if>
            <if test="backtime != null">
                backtime = #{backtime},
            </if>
            <if test="borrowtime != null">
                borrowtime=#{borrowtime},
            </if>
            <if test="secondUid != 0">
                secondUid = #{secondUid},
            </if>
            <if test="shouldback != null">
                shouldback=#{shouldback},
            </if>
            <if test="fileid != 0">
                fileid=#{fileid},
            </if>
            <if test="borrowstate != 0">
                borrowstate=#{borrowstate}
            </if>
        </set>
        where fileid = #{fileid}
    </update>
    <!--修改文件信息-->
    <update id="updateCompanyFileById" parameterType="cn.fm.pojo.CompanyFile" >
        update companyFile
        <set>
            <if test="isborrow != 0">
                isborrow = #{isborrow},
            </if>
            <if test="cfname != null">
                cfname = #{cfname},
            </if>
            <if test="cfaccept !=null">
                cfaccept=#{cfaccept},
            </if>
            <if test="cfeditor != null">
                cfeditor = #{cfeditor},
            </if>
            <if test="cfsend != null" >
                cfsend = #{cfsend},
            </if>
            <if test="cflevel != null">
                cflevel = #{cflevel},
            </if>
            <if test="leveltime != null">
                leveltime = #{leveltime},
            </if>
            <if test="cfloader != null">
                cfloader =#{cfloader},
            </if>
            <if test="cfnumber != 0">
                cfnumber = #{cfnumber},
            </if>
            <if test="cffontid != null">
                cffontid = #{cffontid},
            </if>
            <if test="cflanguage != null" >
                cflanguage = #{cflanguage},
            </if>
            <if test="state != 0">
                state = #{state},
            </if>
            <if test="waitborrow != 0">
                waitborrow = #{waitborrow},
            </if>
            <if test="destroy != 0 ">
                destroy = #{destroy},
            </if>
            <if test="back != 0">
                back = #{back},
            </if>
            <!--<if test="back != 0">-->
                <!--back = #{back},-->
            <!--</if>-->
            <if test="destroyDate != null">
                destroyDate = #{destroyDate},
            </if>
            <if test="backDate != null">
                backDate = #{backDate}
            </if>
        </set>
        where  cfid = #{cfid}
    </update>
    <!--修改文件为删除状态-->
    <update id="delCompanyFileById" parameterType="java.lang.Integer">
        update companyFile set state=0 where cfid IN
        <foreach collection="cfid" item="id" separator="," close=")" open="(">
            #{id}
        </foreach>
    </update>
    <update id="delBorrow_CompanyFileByCFId" parameterType="java.lang.Integer">
        update borrow_companyFile set borrowstate=#{state} WHERE fileid IN
        <foreach collection="cfid" item="id" separator="," close=")" open="(">
            #{id}
        </foreach>
    </update>
    <!--查询文件的信息,根据除id以外的所有字段-->
    <!--扩展类的文件map-->
    <resultMap id="companyFileMap" type="cn.fm.vo.BorrowCFExtends">
        <association property="borrow" javaType="cn.fm.pojo.Borrow">
            <result property="fileid" column="fileid" />
            <result property="wid" column="wid"/>
            <result property="uid" column="uid"/>
            <result property="secondUid" column="secondUid"/>
            <result property="backtime" column="backtime" />
            <result property="shouldback" column="shouldback"/>
            <result property="givetime" column="givetime"/>
            <result property="borrowtime" column="borrowtime"/>
            <result property="borrowstate" column="borrowstate"/>
        </association>
        <association property="companyFile" javaType="cn.fm.pojo.CompanyFile">
            <id property="cfid" column="cfid"/>
            <result property="cfname" column="cfname"/>
            <result property="cfdate" column="cfdate"/>
            <result property="cfaccept" column="cfaccept"/>
            <result property="cfeditor" column="cfeditor"/>
            <result property="cfsend" column="cfsend"/>
            <result property="cflevel" column="cflevel"/>
            <result property="leveltime" column="leveltime"/>
            <result property="cfloader" column="cfloader"/>
            <result property="cfnumber" column="cfnumber"/>
            <result property="cffontid" column="cffontid"/>
            <result property="cflanguage" column="cflanguage"/>
            <result property="cfaddress" column="cfaddress"/>
            <result property="cfclassifyid" column="cfclassifyid"/>
            <result property="cfclassifyname" column="cfclassifyname"/>
            <result property="type" column="type"/>
            <result property="isborrow" column="isborrow"/>
            <result property="state" column="state"/>
            <result property="waitborrow" column="waitborrow"/>
            <result property="destroy" column="destroy"/>
            <result property="destroyDate" column="destroyDate"/>
            <result property="back" column="back"/>
            <result property="backDate" column="backDate"/>
        </association>
    </resultMap>
    <!--isborrow 有三种情况0,1,2 ,0表示没被借走,1表示借走没还,2表示归还了的,下面用isborrow!=0做条件
    就是说,如果 isborrow=0就会查看所有的文件的信息, waitborrow也是一个意思,0,1,2,0表示没有分配,1表示
    分配了没有领走,2表示领走了,一般只根据1来查询-->
    <select id="selectCompanyFile" resultMap="companyFileMap">
        select * from companyFile cf
        left join borrow_companyFile bcf on (bcf.fileid = cf.cfid)
        <where>
            <if test="companyFile.cfid != 0">
                cf.cfid = #{companyFile.cfid}
            </if>
            <if test="companyFile.cfname != null">
                and cf.cfname like concat(concat('%',#{companyFile.cfname}), '%')
            </if>
            <if test="companyFile.cfdate != null" >
                and (cf.cfdate  BETWEEN #{companyFile.cfdate} and  #{endtime})
            </if>
            <if test="companyFile.cfaccept != null">
                and cf.cfaccept = #{companyFile.cfaccept}
            </if>
            <if test="companyFile.cfeditor != null">
                and cf.cfeditor = #{companyFile.cfeditor}
            </if>
            <if test="companyFile.cfsend != null">
                and cf.cfsend = #{companyFile.cfsend}
            </if>
            <if test="level == 1">
                and cf.cflevel != "普通"
            </if>
            <if test="level == 2">
                AND cf.cflevel = "普通"
            </if>
            <if test="companyFile.cflanguage != null">
                and cf.cflanguage = #{companyFile.cflanguage}
            </if>
            <if test="companyFile.cfclassifyid != 0">
                and cf.cfclassifyid = #{companyFile.cfclassifyid}
            </if>
            <if test="companyFile.isborrow != 0">
                and cf.isborrow = #{companyFile.isborrow}
            </if>
            <if test="companyFile.waitborrow != 0">
                and cf.waitborrow = #{companyFile.waitborrow}
            </if>
            <if test="companyFile.destroy != 0">
               and cf.destroy =#{companyFile.destroy}
            </if>
            <if test="companyFile.back != 0">
              and  cf.back = #{companyFile.back}
            </if>
            <if test="wid != 0">
                and bcf.wid = #{wid}
            </if>
            and cf.state = #{companyFile.state}
        </where>
    </select>

    <!--根据借阅表的信息查找文件的信息 -->
    <select id="selectCompanyFileBorrowInfo" resultMap="companyFileMap" parameterType="java.lang.Integer">
        select * from companyFile cf RIGHT JOIN borrow_companyFile bcf on (bcf.fileid = cf.cfid )
        where cf.state = 1
        <if test="wid != 0">
           and  (bcf.wid = #{wid} )
        </if>
    </select>
    <!--根据用户id查找他领取和分配给他的文件信息-->
    <select id="selectCompanyFileByUid" parameterType="java.lang.Integer" resultMap="companyFileMap">
        select * from companyFile cf
        left join borrow_companyFile bcf on (bcf.fileid = cf.cfid) where bcf.uid = #{uid} OR  bcf.secondUid = #{uid}
        and cf.state=#{state}
    </select>

    <!--下面是收文的数据库操作-->


    <sql id="Base_getFile_Columns" >
        gfid,gfname,gfloader,gffrom ,gflevel,gettime,gfcompany,gfresult,gfdatetime,gfnumber,gfpersonRead,gfpersonReadCom, gfpartnumber,type,isborrow,
        back,state,backDate,waitborrow
    </sql>
    <!--光查询文件的信息, 不算上借阅的信息, 和CompanyFile不同之处 , 根据所有的字段-->
    <select id="selectGetFile"  resultType="cn.fm.pojo.GetFile">
        select <include refid="Base_getFile_Columns" /> from getFile
        <where>
            <if test="getFile.gfname != null">
                gfname like concat(concat('%',#{getFile.gfname}), '%')
            </if>
            <if test="getFile.gffrom != null">
                and gffrom = #{getFile.gffrom}
            </if>
            <if test="level == 1">
                and gflevel != "普通"
            </if>
            <if test="level == 2">
                and gflevel = "普通"
            </if>
            <if test="getFile.gfcompany != null">
                and gfcompany = #{getFile.gfcompany}
            </if>
            <if test="getFile.isborrow != 0">
                and getFile.isborrow = #{getFile.isborrow}
            </if>
            <if test="getFile.gfpartnumber != null">
                and gfpartnumber = #{getFile.gfpartnumber}
            </if>
            <if test="getFile.gfpersonRead != null">
                and gfpersonRead = #{getFile.gfpersonRead}
            </if>
            <if test="getFile.gfnumber != null">
                and gfnumber = #{getFile.gfnumber}
            </if>

            <if test="getFile.back != 0">
                and back = #{getFile.back}
            </if>
            <if test="getFile.waitborrow != 0">
                and waitborrow = #{getFile.waitborrow}
            </if>
            <if test="getFile.gfdatetime != null">
                and ( gfdatetime BETWEEN #{getFile.gfdatetime} and  #{endtime})
            </if>
            and state = #{getFile.state}
        </where>
    </select>
    <!--根据文件id查找文件的信息-->
    <select id="selectGetFileByGFid" resultType="cn.fm.pojo.GetFile" parameterType="java.lang.Integer">
        select <include refid="Base_getFile_Columns"/> from getFile where gfid = #{gfid}
    </select>

    <update id="updateGetFileByGFid" parameterType="cn.fm.pojo.GetFile" >
        update getFile
        <set>
            <if test="gfname != null">
                gfname = #{gfname},
            </if>
            <if test="gfidea != null">
                gfidea = #{gfidea},
            </if>
            <if test="gfloader != null">
                gfloader = #{gfloader},
            </if>
            <if test="gffrom != null">
                gffrom = #{gffrom},
            </if>
            <if test="gflevel != null">
                gflevel = #{gflevel},
            </if>
            <if test="gettime != null">
                gettime = #{gettime},
            </if>
            <if test="gfcompany != null">
                gfcompany = #{gfcompany},
            </if>
            <if test="gfresult != null">
                gfresult = #{gfresult},
            </if>
            <if test="gfdatetime != null">
                gfdatetime = #{gfdatetime},
            </if>
            <if test="gfnumber != null">
                gfnumber = #{gfnumber},
            </if>
            <if test="gfpersonRead != null">
                gfpersonRead = #{gfpersonRead},
            </if>
            <if test="gfpersonReadCom != null">
                gfpersonReadCom = #{gfpersonReadCom},
            </if>
            <if test="gfpartnumber != null">
                gfpartnumber = #{gfpartnumber},
            </if>
            <if test="isborrow != 0">
                isborrow = #{isborrow},
            </if>
            <if test="back != 0">
                back = #{back},
            </if>
            <if test="backDate != null">
                backDate = #{backDate},
            </if>
            <if test="waitborrow != 0">
                waitborrow = #{waitborrow},
            </if>
            <if test="state != 0">
                state = #{state}
            </if>
        </set>
        where gfid = #{gfid}
    </update>
    <!--添加文件信息-->
    <insert id="insertGetFile" parameterType="cn.fm.pojo.GetFile">
        <selectKey  keyProperty="gfid" resultType="java.lang.Integer" order="AFTER">
            select LAST_INSERT_ID()
        </selectKey>
        insert into getFile(gfname,gfidea,gfloader,gffrom,gflevel,gettime,gfcompany,gfresult,
        gfdatetime,gfnumber,gfpersonRead,gfpersonReadCom,gfpartnumber) values (
        #{gfname} , #{gfidea},#{gfloader},#{gffrom},#{gflevel},#{gettime},#{gfcompany},
        #{gfresult},#{gfdatetime},#{gfnumber},#{gfpersonRead},#{gfpersonReadCom},#{gfpartnumber}
        )
    </insert>
    <!--根据文件的id修改借阅表的-->
    <update id="updateBorrow_GetFileByGFId" parameterType="cn.fm.pojo.Borrow" >
        update borrow_getFile
        <set>
            <if test="uid != 0">
                uid=#{uid},
            </if>

            <if test="givetime != null">
                givetime = #{givetime},
            </if>
            <if test="backtime != null">
                backtime = #{backtime},
            </if>
            <if test="borrowtime != null">
                borrowtime=#{borrowtime},
            </if>
            <if test="thirdUid != 0">
                thirdUid = #{thirdUid},
            </if>
            <if test="secondUid != 0">
                secondUid = #{secondUid},
            </if>
            <if test="shouldback != null">
                shouldback=#{shouldback},
            </if>
            <if test="fileid != 0">
                fileid=#{fileid},
            </if>
            <if test="borrowstate != 0">
                borrowstate=#{borrowstate}
            </if>
        </set>
        where fileid = #{fileid} and wid =#{wid}
    </update>
    <!-- 根据字符数组删除文件信息-->
    <update id="delGetFileByGfid" parameterType="java.lang.Integer">
        update  getFile set state = 0 where  gfid IN
        <foreach collection="gfids" item="id" separator="," close=")"  open="(">
            #{id}
        </foreach>
    </update>

    <!--同时删除文件的借阅信息-->
    <update id="delGetFileBorrowInfoByGfid" parameterType="java.lang.Integer">
        update  borrow_getFile set borrowstate = #{state} where  fileid IN
        <foreach collection="gfids" item="id" separator="," close=")"  open="(">
            #{id}
        </foreach>
    </update>

    <!--添加借阅信息-->
    <insert id="insertBorrow_GetFile" parameterType="cn.fm.pojo.Borrow">
        insert into borrow_getFile(fileid,uid,wid,givetime) VALUES (#{fileid},#{uid},#{wid},#{givetime})
    </insert>
    <!--查询文件的信息,根据除id以外的所有字段-->
    <!--扩展类的文件map-->
    <resultMap id="getFileMap" type="cn.fm.vo.BorrowGFExtends">
        <association property="borrow" javaType="cn.fm.pojo.Borrow">
            <result property="fileid" column="fileid" />
            <result property="wid" column="wid"/>
            <result property="uid" column="uid"/>
            <result property="secondUid" column="secondUid"/>
            <result property="thirdUid" column="thirdUid"/>
            <result property="backtime" column="backtime" />
            <result property="shouldback" column="shouldback"/>
            <result property="givetime" column="givetime"/>
            <result property="borrowtime" column="borrowtime"/>
            <result property="borrowstate" column="borrowstate"/>
        </association>
        <association property="getFile" javaType="cn.fm.pojo.GetFile">
            <id property="gfid" column="gfid"/>
            <result property="gfname" column="gfname"/>
            <result property="gfidea" column="gfidea"/>
            <result property="gfloader" column="gfloader"/>
            <result property="gffrom" column="gffrom"/>
            <result property="gflevel" column="gflevel"/>
            <result property="gettime" column="gettime"/>
            <result property="gfcompany" column="gfcompany"/>
            <result property="gfresult" column="gfresult"/>
            <result property="gfdatetime" column="gfdatetime"/>
            <result property="gfpersonRead" column="gfpersonRead"/>
            <result property="gfpersonReadCom" column="gfpersonReadCom"/>
            <result property="gfpartnumber" column="gfpartnumber"/>
            <result property="type" column="type"/>
            <result property="isborrow" column="isborrow"/>
            <result property="state" column="state"/>
            <result property="waitborrow" column="waitborrow"/>
            <result property="back" column="back"/>
            <result property="backDate" column="backDate"/>
        </association>
    </resultMap>
<!--查找包括借阅信息在内的信息 ,根据用户的单位查-->
    <select id="selectGetFileAndBorrowInfo" resultMap="getFileMap">
        select * from getFile gf
        right join borrow_getFile bgf on (bgf.fileid = gf.gfid)
        <where>
            gf.state = 1
            <if test="wid != 0">
              and  bgf.wid =  #{wid}
            </if>
        </where>
    </select>
    <!--根据用户id查找文件信息-->
    <select id="selectGetFileByUid" parameterType="java.lang.Integer" resultMap="getFileMap">
    select * from getFile gf
    right join borrow_getFile bgf on (bgf.fileid = gf.gfid) where bgf.uid = #{uid} OR  bgf.secondUid = #{uid} or bgf.thirdUid = #{uid}
    and gf.state=1
    </select>

</mapper>